# services/rag_streamlit.py
import streamlit as st
import os, glob
from chromadb import PersistentClient
from services.rag import _embedding_function, _read, _read_qa_csv, _read_qa_md, FAQDIR, DBDIR, _OPENAI_CLIENT

# ---------------- ì•ˆì „ ë¹Œë“œ ----------------
def safe_build_index():
    """ê¸°ì¡´ ì»¬ë ‰ì…˜ ì‚­ì œ í›„ ìƒˆ ì„ë² ë”© í•¨ìˆ˜ë¡œ ì•ˆì „í•˜ê²Œ ìƒ‰ì¸"""
    os.makedirs(DBDIR, exist_ok=True)
    cli = PersistentClient(path=DBDIR)

    # 1) ê¸°ì¡´ ì»¬ë ‰ì…˜ ì‚­ì œ
    try:
        cli.delete_collection("faqs_openai")
        st.write("ê¸°ì¡´ ì»¬ë ‰ì…˜ ì‚­ì œ ì™„ë£Œ")
    except Exception:
        st.write("ì‚­ì œí•  ì»¬ë ‰ì…˜ ì—†ìŒ, ìƒˆë¡œ ìƒì„±")

    # 2) ìƒˆ ì»¬ë ‰ì…˜ ìƒì„±
    col = cli.get_or_create_collection("faqs_openai", embedding_function=_embedding_function())

    # 3) ë¬¸ì„œ ìƒ‰ì¸
    ids, docs, metas = [], [], []
    files = glob.glob(f"{FAQDIR}/*.md") + glob.glob(f"{FAQDIR}/*.txt") + glob.glob(f"{FAQDIR}/*.pdf")
    for f in files:
        txt = _read(f)
        if not txt.strip():
            continue
        ids.append(os.path.basename(f))
        docs.append(txt[:10000])
        metas.append({"path": f})
    if ids:
        col.upsert(ids=ids, documents=docs, metadatas=metas)
        st.write(f"{len(ids)}ê°œ ë¬¸ì„œ ìƒ‰ì¸ ì™„ë£Œ")

    # 4) CSV/MD Q&A ìƒ‰ì¸
    qa_files = glob.glob(f"{FAQDIR}/*.csv") + glob.glob(f"{FAQDIR}/faq_qa.md") + glob.glob(f"{FAQDIR}/*_qa.md")
    q_ids, q_docs, q_metas = [], [], []
    for f in qa_files:
        pairs = _read_qa_csv(f) if f.endswith(".csv") else _read_qa_md(f)
        for idx, (q, a) in enumerate(pairs):
            q_ids.append(f"{os.path.basename(f)}::Q{idx+1}")
            q_docs.append(f"[Q] {q}\n[A] {a}")
            q_metas.append({"path": f, "type": "qa"})
    if q_ids:
        col.upsert(ids=q_ids, documents=q_docs, metadatas=q_metas)
        st.write(f"{len(q_ids)}ê°œ Q&A ìƒ‰ì¸ ì™„ë£Œ")

    #cli.persist()
    st.write("ì»¬ë ‰ì…˜ ë¹Œë“œ ë° ì €ì¥ ì™„ë£Œ")

# ---------------- RAG ì§ˆì˜ ----------------
def safe_rag_query(question: str, k: int = 3):
    cli = PersistentClient(path=DBDIR)
    col = cli.get_or_create_collection("faqs_openai", embedding_function=_embedding_function())
    r = col.query(query_texts=[question], n_results=k)
    ctx = "\n\n".join(r["documents"][0]) if r and r.get("documents") else ""

    if _OPENAI_CLIENT is not None and ctx.strip():
        msgs = [
            {"role": "system", "content": "ì‚¬ë‚´ ê·œì •/FAQë¥¼ ë°”íƒ•ìœ¼ë¡œ ê°„ê²°íˆ í•œêµ­ì–´ë¡œ ë‹µí•˜ì„¸ìš”. ì¸ìš©ì€ ë”°ì˜´í‘œë¡œ í‘œì‹œ."},
            {"role": "user",   "content": f"[ì»¨í…ìŠ¤íŠ¸]\n{ctx}\n\n[ì§ˆë¬¸]\n{question}"},
        ]
        try:
            a = _OPENAI_CLIENT.chat.completions.create(
                model=os.getenv("OPENAI_MODEL", "gpt-4o-mini"),
                messages=msgs,
                temperature=0.1,
            )
            return a.choices[0].message.content
        except Exception as e:
            st.write("âŒ LLM ì˜¤ë¥˜:", e)

    return f"ìƒìœ„ ìŠ¤ë‹ˆí«:\n{ctx[:1200]}\n\n(OPENAI_API_KEY ì—†ê±°ë‚˜ ì˜¤ë¥˜ ì‹œ ìŠ¤ë‹ˆí«ë§Œ í‘œì‹œ)"

# ---------------- Streamlit UI ----------------
st.title("ğŸ“š RAG FAQ ì§ˆì˜")

user_input = st.text_input("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”:")

if st.button("ê´€ë¦¬ììš©: ìƒ‰ì¸ ì¬ë¹Œë“œ"):
    safe_build_index()

if user_input:
    st.write(f"ì…ë ¥: {user_input}")
    answer = safe_rag_query(user_input)
    st.markdown("### RAG ë‹µë³€")
    st.write(answer)
